@using EventHub.ViewModels
@model ProfileViewModel

@{
    ViewBag.Title = "Profile - EventHub";
}

<!-- Profile Section  -->
<section class="profile-section">
    <div class="container">
        <!-- User Info Card with Edit Button -->
        <div class="profile-header fade-in">
            <div class="profile-avatar">
                @if (!string.IsNullOrEmpty(Model.ProfilePhoto))
                {
                    <img src="@Model.ProfilePhoto"
                         alt="Profile Photo"
                         style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                }
                else
                {
                    <span>@Model.FullName.ToUpper().First()</span>
                }
            </div>
            <div class="profile-info">
                <h1>@Model.FullName</h1>
                <p>@Model.Email</p>
                <span class="user-type">@Model.UserType</span>
            </div>
            <a asp-controller="Profile" asp-action="Edit" class="btn btn-primary" style="margin-left: auto;">Edit Profile</a>
        </div>

        <!-- Tickets Section  -->
        <div class="profile-content">
            <div class="section-header slide-up">
                <h2>My Tickets</h2>
                <p id="ticketCount">0 tickets</p>
            </div>

            <!-- Filter Tabs  -->
            <div class="ticket-filters slide-up">
                <button class="filter-btn active" data-filter="all">All Tickets</button>
                <button class="filter-btn" data-filter="upcoming">Upcoming</button>
                <button class="filter-btn" data-filter="past">Past Events</button>
            </div>

            <!-- Tickets Grid  -->
            <div id="ticketsGrid" class="tickets-grid"></div>
        </div>
    </div>
</section>


@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        let currentFilter = "all";

        // Load tickets on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadTickets(currentFilter);

            // filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    currentFilter = e.target.dataset.filter;
                    loadTickets(currentFilter);
                });
            });
        });

        // =========================
        // AJAX: Load Tickets
        // =========================
        function loadTickets(filter) {
            fetch(`/Ticket/GetMyTickets?filter=${filter}`)
                .then(res => res.json())
                .then(tickets => {
                    document.getElementById('ticketCount').textContent = `${tickets.length} tickets`;
                    displayTickets(tickets);
                });
        }

        // =========================
        // Render Tickets to UI
        // =========================
        function displayTickets(tickets) {
            const container = document.getElementById('ticketsGrid');
            container.innerHTML = "";

            if (tickets.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">🎫</div>
                        <h3>No tickets found</h3>
                        <p>You haven't purchased any tickets yet</p>
                    </div>
                `;
                return;
            }

            const now = new Date();

            container.innerHTML = tickets.map((ticket, index) => {
                const eventDate = new Date(ticket.eventDate);
                const isPast = eventDate < now;
                const isUsed = ticket.used;

                return `
                <div class="ticket-card slide-up" style="animation-delay: ${index * 0.1}s">
                    <div class="ticket-status-badge ${isPast ? 'past' : 'upcoming'}">
                        ${isPast ? 'Past Event' : 'Upcoming'}
                    </div>

                    <div class="ticket-card-header">
                        <h3>${ticket.eventName}</h3>
                        <span class="ticket-id">#${ticket.ticketId}</span>
                    </div>

                    <div class="ticket-card-body">
                        <div class="ticket-details-grid">
                            <div class="detail-item">
                                <span class="detail-label">Date</span>
                                <span class="detail-value">${eventDate.toLocaleDateString()}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Time</span>
                                <span class="detail-value">${eventDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Location</span>
                                <span class="detail-value">${ticket.eventLocation}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Price</span>
                                <span class="detail-value">$${ticket.price.toFixed(2)}</span>
                            </div>
                        </div>

                        <div class="ticket-qr-container">
                            <div id="qr-${ticket.ticketId}" class="qr-code-small"></div>
                            <p class="qr-status ${isUsed ? 'used' : 'valid'}">
                                ${isUsed ? '✗ Used' : '✓ Valid'}
                            </p>
                        </div>
                    </div>

                    <div class="ticket-card-footer">
                        <a class="btn-link" href="/Ticket/Details/${ticket.ticketId}">View Details</a>
                    </div>
                </div>`;
            }).join('');

            // Generate QR codes
            setTimeout(() => {
                tickets.forEach(ticket => {
                    const qrDiv = document.getElementById(`qr-${ticket.ticketId}`);
                    if (!qrDiv) return;

                    new QRCode(qrDiv, {
                        text: ticket.qrCode,
                        width: 120,
                        height: 120
                    });
                });
            }, 100);
        }
    </script>
}
